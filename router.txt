package routes

import (
	"context"

	"github.com/ZhijiunY/restaurant-service-system/controllers"
	"github.com/ZhijiunY/restaurant-service-system/middleware"
	"github.com/gin-contrib/sessions"
	"github.com/gin-contrib/sessions/postgres"
	"github.com/gin-gonic/gin"
	"github.com/go-redis/redis/v8"
	"gorm.io/gorm"
)

const (
	sessionName = "my-session"
	userkey     = "user"
)

var secret = []byte("secret")

func InitRouter(redisClient *redis.Client, db *gorm.DB) *gin.Engine {
	router := gin.Default()

	router.Use(middleware.Logger())
	router.Use(gin.Recovery())
	router.Use(gin.BasicAuth(gin.Accounts{"Simba": "1234"}))

	// 從 gorm.DB 獲取底層的 *sql.DB 對象
	sqlDB, err := db.DB()
	if err != nil {
		panic("failed to get sql.DB from gorm.DB: " + err.Error())
	}

	// 使用 PostgreSQL 存儲會話
	store, err := postgres.NewStore(sqlDB, []byte("secret"))
	if err != nil {
		panic("failed to create session store: " + err.Error())
	}
	router.Use(sessions.Sessions(sessionName, store))

	// session
	middleware.EnableCookieSession()
	// store := cookie.NewStore(secret)
	sessionController := controllers.NewSessionController(store)
	orderController := controllers.NewOrderController(redisClient, context.Background())

	router.Use(sessions.Sessions(sessionName, store))
	router.Use(sessionController.LoadAndSave())
	router.LoadHTMLGlob("./templates/**/*")
	router.Static("/static", "./static")

	setupMainRoutes(router, sessionController)
	setupOrderRoutes(router, sessionController, orderController)
	setupAuthRoutes(router, sessionController)

	return router
}

func setupMainRoutes(router *gin.Engine, sessionController *controllers.SessionController) {
	mainRoutes := router.Group("/")
	{
		mainRoutes.GET("/", controllers.GetIndex)
		mainRoutes.GET("/menu", sessionController.AuthRequired(), controllers.GetMenu())
	}
}

func setupOrderRoutes(router *gin.Engine, sessionController *controllers.SessionController, orderController *controllers.OrderController) {
	orderRoutes := router.Group("/order")
	{
		orderRoutes.GET("/", orderController.GetOrder())
		orderRoutes.POST("/submit-order", sessionController.AuthRequired(), orderController.SubmitOrder())
		orderRoutes.GET("/show-orders", sessionController.AuthRequired(), orderController.ShowOrders())
		orderRoutes.GET("/generate-qr", sessionController.AuthRequired(), orderController.GenerateOrderQRCode())
		orderRoutes.Static("/static", "./static")
	}
}

func setupAuthRoutes(router *gin.Engine, sessionController *controllers.SessionController) {
	authRoutes := router.Group("/auth")
	{
		authRoutes.GET("/getlogin", sessionController.LoginGet())
		authRoutes.GET("/signup", sessionController.SignupGet())
		authRoutes.POST("/login", sessionController.LoginPost())
		authRoutes.POST("/logout", sessionController.LogoutPost())
		authRoutes.POST("/signup", sessionController.SignupPost())
		authRoutes.Static("/static", "./static")
	}
}

===
package routes

import (
	"context"

	"github.com/ZhijiunY/restaurant-service-system/controllers"
	"github.com/ZhijiunY/restaurant-service-system/middleware"
	"github.com/gin-contrib/sessions"
	"github.com/gin-contrib/sessions/postgres"
	"github.com/gin-gonic/gin"
	"github.com/go-redis/redis/v8"
	"gorm.io/gorm"
)

const (
	sessionName = "my-session"
	userkey     = "user"
)

var secret = []byte("secret")

func InitRouter(redisClient *redis.Client, db *gorm.DB) *gin.Engine {
	router := gin.Default()

	router.Use(middleware.Logger())
	router.Use(gin.Recovery())
	router.Use(gin.BasicAuth(gin.Accounts{"Simba": "1234"}))

	// 從 gorm.DB 獲取底層的 *sql.DB 對象
	sqlDB, err := db.DB()
	if err != nil {
		panic("failed to get sql.DB from gorm.DB: " + err.Error())
	}

	// 使用 PostgreSQL 存儲會話
	store, err := postgres.NewStore(sqlDB, []byte("secret"))
	if err != nil {
		panic("failed to create session store: " + err.Error())
	}
	router.Use(sessions.Sessions(sessionName, store))

	// session
	middleware.EnableCookieSession()
	// store := cookie.NewStore(secret)
	sessionController := controllers.NewSessionController(store)
	orderController := controllers.NewOrderController(redisClient, context.Background())

	router.Use(sessions.Sessions(sessionName, store))
	router.Use(sessionController.LoadAndSave())
	router.LoadHTMLGlob("./templates/**/*")
	router.Static("/static", "./static")

	setupMainRoutes(router, sessionController)
	setupOrderRoutes(router, sessionController, orderController)
	setupAuthRoutes(router, sessionController)

	return router
}

func setupMainRoutes(router *gin.Engine, sessionController *controllers.SessionController) {
	mainRoutes := router.Group("/")
	{
		mainRoutes.GET("/", controllers.GetIndex)
		mainRoutes.GET("/menu", sessionController.AuthRequired(), controllers.GetMenu())
	}
}

func setupOrderRoutes(router *gin.Engine, sessionController *controllers.SessionController, orderController *controllers.OrderController) {
	orderRoutes := router.Group("/order")
	{
		orderRoutes.GET("/", orderController.GetOrder())
		orderRoutes.POST("/submit-order", sessionController.AuthRequired(), orderController.SubmitOrder())
		orderRoutes.GET("/show-orders", sessionController.AuthRequired(), orderController.ShowOrders())
		orderRoutes.GET("/generate-qr", sessionController.AuthRequired(), orderController.GenerateOrderQRCode())
		orderRoutes.Static("/static", "./static")
	}
}

func setupAuthRoutes(router *gin.Engine, sessionController *controllers.SessionController) {
	authRoutes := router.Group("/auth")
	{
		authRoutes.GET("/getlogin", sessionController.LoginGet())
		authRoutes.GET("/signup", sessionController.SignupGet())
		authRoutes.POST("/login", sessionController.LoginPost())
		authRoutes.POST("/logout", sessionController.LogoutPost())
		authRoutes.POST("/signup", sessionController.SignupPost())
		authRoutes.Static("/static", "./static")
	}
}


======

package routes

import (
	"context"

	"github.com/ZhijiunY/restaurant-service-system/controllers"
	"github.com/ZhijiunY/restaurant-service-system/middleware"
	"github.com/gin-contrib/sessions"
	"github.com/gin-contrib/sessions/postgres"
	"github.com/gin-gonic/gin"
	"github.com/go-redis/redis/v8"
	"gorm.io/gorm"
)

const (
	sessionName = "my-session"
	userkey     = "user"
	secret      = "secret"
)

func InitRouter(redisClient *redis.Client, db *gorm.DB) *gin.Engine {
	router := gin.Default()
	setupMiddlewares(router, db)
	setupRoutes(router, redisClient, db)
	return router
}

func setupMiddlewares(router *gin.Engine, db *gorm.DB) {
	router.Use(
		middleware.Logger(),
		gin.Recovery(),
		gin.BasicAuth(gin.Accounts{"Simba": "1234"}),
	)

	sqlDB, err := db.DB() // 從 gorm.DB 獲取底層的 *sql.DB 對象
	if err != nil {
		panic("failed to get sql.DB from gorm.DB: " + err.Error())
	}

	// 使用 PostgreSQL 存儲會話
	store, err := postgres.NewStore(sqlDB, []byte(secret))
	if err != nil {
		panic("failed to create session store: " + err.Error())
	}
	router.Use(sessions.Sessions(sessionName, store))
}

func setupRoutes(router *gin.Engine, redisClient *redis.Client, db *gorm.DB) {
	// 初始化控制器
	sessionController := controllers.NewSessionController(store)
	orderController := controllers.NewOrderController(redisClient, context.Background())

	router.LoadHTMLGlob("./templates/**/*")
	router.Static("/static", "./static")

	mainRoutes := router.Group("/")
	// mainRoutes.GET("/", controllers.GetIndex)
	// mainRoutes.GET("/menu", sessionController.AuthRequired(), controllers.GetMenu())
	setupMainRoutes(mainRoutes, sessionController)

	orderRoutes := router.Group("/order")
	setupOrderRoutes(orderRoutes, sessionController, orderController)

	authRoutes := router.Group("/auth")
	setupAuthRoutes(authRoutes, sessionController)
}

func setupMainRoutes(mainRoutes *gin.RouterGroup, sessionController *controllers.SessionController) {
	mainRoutes.GET("/", controllers.GetIndex)
	mainRoutes.GET("/menu", sessionController.AuthRequired(), controllers.GetMenu())
}

func setupOrderRoutes(orderRoutes *gin.RouterGroup, sessionController *controllers.SessionController, orderController *controllers.OrderController) {
	orderRoutes.GET("/", orderController.GetOrder())
	orderRoutes.POST("/submit-order", sessionController.AuthRequired(), orderController.SubmitOrder())
	orderRoutes.GET("/show-orders", sessionController.AuthRequired(), orderController.ShowOrders())
	orderRoutes.GET("/generate-qr", sessionController.AuthRequired(), orderController.GenerateOrderQRCode())
	orderRoutes.Static("/static", "./static")
}

func setupAuthRoutes(authRoutes *gin.RouterGroup, sessionController *controllers.SessionController) {
	authRoutes.GET("/getlogin", sessionController.LoginGet())
	authRoutes.GET("/signup", sessionController.SignupGet())
	authRoutes.POST("/login", sessionController.LoginPost())
	authRoutes.POST("/logout", sessionController.LogoutPost())
	authRoutes.POST("/signup", sessionController.SignupPost())
	authRoutes.Static("/static", "./static")
}
